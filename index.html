<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Climix</title>

<style>
body{background:#000;color:#fff;font-family:system-ui;margin:0}
.app{max-width:420px;margin:auto;padding:15px}
.card{background:#111;padding:16px;border-radius:16px;margin-bottom:12px}
input,button{height:42px;border:none;border-radius:12px}
input{width:55%;padding:0 10px}
button{background:#222;color:#fff}
.temp{font-size:3.5rem;text-align:center}
.status{text-align:center;opacity:.7;margin-top:5px}
.row{display:flex;justify-content:space-between;padding:6px 0}
.aqi{text-align:center;font-size:1.5rem}
canvas{width:100%}
</style>
</head>

<body>
<div class="app">

<h2>Climix</h2>

<div class="card">
<input id="city" placeholder="Enter city">
<button onclick="searchCity()">Search</button>
<button onclick="detect()">üìç</button>
</div>

<div class="card">
<div id="temp" class="temp">--¬∞C</div>
<div id="status" class="status">Ready</div>
</div>

<div class="card">
<div class="row">Humidity <span id="hum">--</span></div>
<div class="row">Wind <span id="wind">--</span></div>
<div class="row">Pressure <span id="press">--</span></div>
</div>

<div class="card">
<h3>Air Quality</h3>
<div id="aqi" class="aqi">--</div>
<div id="aqiText" class="status"></div>
</div>

<div class="card">
<h3>Next 24 Hours</h3>
<canvas id="chart" width="350" height="120"></canvas>
</div>

<div class="card" style="text-align:center;font-size:.8rem">
¬© Manik Roy 2025
</div>

</div>

<script>
let busy=false;
const $=id=>document.getElementById(id);

function setStatus(t){ $("status").textContent=t; }

/* Load last location */
window.onload=()=>{
  const lat=localStorage.getItem("lat");
  const lon=localStorage.getItem("lon");
  if(lat && lon) loadWeather(lat,lon);
}

/* Detect location */
async function detect(){
  if(busy) return;
  busy=true;
  setStatus("Requesting location...");

  navigator.geolocation.getCurrentPosition(
    async p=>{
      busy=false;
      save(p.coords.latitude,p.coords.longitude);
      await loadWeather(p.coords.latitude,p.coords.longitude);
      getCityName(p.coords.latitude,p.coords.longitude);
    },
    ()=>{
      busy=false;
      setStatus("Location denied");
    },
    {timeout:15000}
  );
}

/* Reverse geocode */
async function getCityName(lat,lon){
  try{
    const r=await fetch(
      `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}`
    );
    const j=await r.json();
    if(j.results && j.results.length>0){
      $("city").value=j.results[0].name;
    }
  }catch{}
}

/* Search city */
async function searchCity(){
  if(!$("city").value || busy) return;
  busy=true;
  setStatus("Searching city...");

  try{
    const r=await fetch(
      `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent($("city").value)}&count=1`
    );
    const j=await r.json();
    if(!j.results) return setStatus("City not found");

    const loc=j.results[0];
    save(loc.latitude,loc.longitude);
    $("city").value=loc.name;
    loadWeather(loc.latitude,loc.longitude);

  }catch{
    setStatus("Search failed");
  }
  busy=false;
}

/* Weather */
async function loadWeather(lat,lon){
  setStatus("Loading weather...");

  try{
    const r=await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
      `&current=temperature_2m,relative_humidity_2m,wind_speed_10m,pressure_msl`+
      `&hourly=temperature_2m,time&timezone=auto`
    );

    const w=await r.json();

    let temp="-", hum="-", wind="-", press="-";

    if(w.current){
      temp=w.current.temperature_2m;
      hum=w.current.relative_humidity_2m;
      wind=w.current.wind_speed_10m;
      press=w.current.pressure_msl;
    }else if(w.hourly?.temperature_2m?.length){
      temp=w.hourly.temperature_2m[0];
    }

    $("temp").textContent=temp!=="-"?Math.round(temp)+"¬∞C":"--¬∞C";
    $("hum").textContent=hum!=="-"?hum+"%":"--";
    $("wind").textContent=wind!=="-"?wind+" km/h":"--";
    $("press").textContent=press!=="-"?press+" hPa":"--";

    if(w.hourly?.temperature_2m){
      drawChart(w.hourly.temperature_2m.slice(0,24));
    }

    loadAQI(lat,lon);
    setStatus("Updated");

  }catch{
    setStatus("Weather error");
  }
}

/* AQI (REAL calculation) */
async function loadAQI(lat,lon){
  try{
    const r=await fetch(
      `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5`
    );
    const a=await r.json();

    const pm=a.hourly.pm2_5[0];
    const aqi=calcAQI(pm);

    $("aqi").textContent="AQI "+aqi;
    $("aqiText").textContent=aqiLabel(aqi);

  }catch{
    $("aqi").textContent="AQI unavailable";
  }
}

/* PM2.5 ‚Üí AQI */
function calcAQI(pm){
  const bp=[
    [0,12,0,50],
    [12.1,35.4,51,100],
    [35.5,55.4,101,150],
    [55.5,150.4,151,200],
    [150.5,250.4,201,300],
    [250.5,500,301,500]
  ];

  for(const [cl,ch,il,ih] of bp){
    if(pm>=cl && pm<=ch){
      return Math.round(((ih-il)/(ch-cl))*(pm-cl)+il);
    }
  }
  return 500;
}

function aqiLabel(a){
  if(a<=50) return "Good üü¢";
  if(a<=100) return "Moderate üü°";
  if(a<=150) return "Unhealthy (Sensitive) üü†";
  if(a<=200) return "Unhealthy üî¥";
  return "Hazardous ‚ö´";
}

/* Chart */
function drawChart(data){
  const c=$("chart").getContext("2d");
  c.clearRect(0,0,350,120);

  const max=Math.max(...data),min=Math.min(...data);
  const step=350/(data.length-1);

  c.beginPath();
  data.forEach((v,i)=>{
    const x=i*step;
    const y=120-((v-min)/(max-min))*120;
    i?c.lineTo(x,y):c.moveTo(x,y);
  });
  c.strokeStyle="#4af";
  c.lineWidth=2;
  c.stroke();
}

/* Save */
function save(lat,lon){
  localStorage.setItem("lat",lat);
  localStorage.setItem("lon",lon);
}
</script>

</body>
</html>
