<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Climix</title>

<style>
body{background:#000;color:#fff;font-family:system-ui;margin:0}
.app{max-width:420px;margin:auto;padding:15px}
.card{background:#111;padding:15px;border-radius:16px;margin-bottom:12px}
button,input{height:42px;border:none;border-radius:12px}
input{width:55%;padding:0 10px}
button{background:#222;color:#fff}
.temp{font-size:3.5rem;text-align:center}
.status{text-align:center;opacity:.7}
.row{display:flex;justify-content:space-between;padding:6px 0}
.aqi{font-size:1.4rem;text-align:center}
</style>
</head>

<body>
<div class="app">

<h2>Climix</h2>

<div class="card">
<input id="city" placeholder="Enter city">
<button onclick="searchCity()">Search</button>
<button onclick="detect()">ğŸ“</button>
</div>

<div class="card">
<div id="temp" class="temp">--Â°C</div>
<div id="status" class="status">Ready</div>
</div>

<div class="card">
<div class="row">Humidity <span id="hum">--</span></div>
<div class="row">Wind <span id="wind">--</span></div>
<div class="row">Pressure <span id="press">--</span></div>
</div>

<!-- AQI CARD -->
<div class="card">
<h3>Air Quality</h3>
<div id="aqi" class="aqi">--</div>
<div id="aqiText" class="status"></div>
</div>

<!-- 7 DAY FORECAST -->
<div class="card">
<h3>7-Day Forecast</h3>
<div id="forecast"></div>
</div>

<div class="card" style="text-align:center;font-size:.8rem">
Â© Manik Roy 2025
</div>

</div>

<script>
let loading=false

function setStatus(msg){
  status.textContent=msg
}

/* AUTO LOAD */
window.onload=()=>{
  const lat=localStorage.getItem("lat")
  const lon=localStorage.getItem("lon")
  if(lat && lon) loadWeather(lat,lon)
}

/* LOCATION */
function detect(){
  if(loading) return
  loading=true
  setStatus("Requesting location...")

  const timer=setTimeout(()=>{
    loading=false
    setStatus("GPS timeout. Use search.")
  },10000)

  navigator.geolocation.getCurrentPosition(
    p=>{
      clearTimeout(timer)
      loading=false
      save(p.coords.latitude,p.coords.longitude)
      loadWeather(p.coords.latitude,p.coords.longitude)
    },
    ()=>{
      clearTimeout(timer)
      loading=false
      setStatus("Location blocked. Use search.")
    },
    {timeout:9000}
  )
}

/* SEARCH */
async function searchCity(){
  if(!city.value || loading) return
  loading=true
  setStatus("Searching city...")

  try{
    const r=await fetch(
      `https://geocoding-api.open-meteo.com/v1/search?name=${city.value}&count=1`
    )
    const j=await r.json()

    if(!j.results){
      loading=false
      return setStatus("City not found")
    }

    save(j.results[0].latitude,j.results[0].longitude)
    loadWeather(j.results[0].latitude,j.results[0].longitude)

  }catch{
    loading=false
    setStatus("Network error")
  }
}

/* WEATHER + AQI */
async function loadWeather(lat,lon){
  setStatus("Loading weather...")

  try{
    const w=await fetch(
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
    `&current=temperature_2m,relative_humidity_2m,wind_speed_10m,pressure_msl`+
    `&daily=temperature_2m_min,temperature_2m_max,time`+
    `&timezone=auto`
    ).then(r=>r.json())

    temp.textContent=Math.round(w.current.temperature_2m)+"Â°C"
    hum.textContent=w.current.relative_humidity_2m+"%"
    wind.textContent=w.current.wind_speed_10m+" km/h"
    press.textContent=w.current.pressure_msl+" hPa"

    forecast.innerHTML=w.daily.time.map((d,i)=>`
      <div class="row">
        <span>${formatDate(d)}</span>
        <span>${Math.round(w.daily.temperature_2m_min[i])}Â° /
              ${Math.round(w.daily.temperature_2m_max[i])}Â°</span>
      </div>
    `).join("")

    loadAQI(lat,lon)
    setStatus("Updated")
    loading=false

  }catch{
    loading=false
    setStatus("Server error")
  }
}

/* AQI */
async function loadAQI(lat,lon){
  try{
    const a=await fetch(
    `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}`+
    `&current=us_aqi`
    ).then(r=>r.json())

    const v=a.current.us_aqi
    aqi.textContent="AQI : "+v
    aqiText.textContent=aqiLabel(v)

  }catch{
    aqi.textContent="AQI unavailable"
  }
}

/* AQI LABEL */
function aqiLabel(v){
  if(v<=50) return "Good ğŸŸ¢"
  if(v<=100) return "Moderate ğŸŸ¡"
  if(v<=150) return "Unhealthy (Sensitive) ğŸŸ "
  if(v<=200) return "Unhealthy ğŸ”´"
  if(v<=300) return "Very Unhealthy ğŸŸ£"
  return "Hazardous âš«"
}

/* FORMAT */
function formatDate(d){
  return new Date(d).toLocaleDateString(undefined,{
    weekday:"short",month:"short",day:"numeric"
  })
}

/* SAVE */
function save(lat,lon){
  localStorage.setItem("lat",lat)
  localStorage.setItem("lon",lon)
}
</script>

</body>
</html>
