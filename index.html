<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Climix</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
 --bg:#0b1220;
 --glass:rgba(255,255,255,.12);
 --text:#fff;
 --accent:#00ffd5;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui}
body{
 background:radial-gradient(circle at top,#111,#000);
 color:var(--text);
 display:flex;
 justify-content:center;
 min-height:100vh;
}
body.amoled{background:#000}
.app{
 width:100%;
 max-width:420px;
 padding:14px;
}
.header{
 display:flex;
 justify-content:space-between;
 align-items:center;
 margin-bottom:10px;
}
h1{font-size:22px}
.toggle{
 background:#000;
 border:1px solid #333;
 border-radius:50%;
 width:36px;
 height:36px;
 color:#fff;
 cursor:pointer;
}
.card{
 background:var(--glass);
 backdrop-filter:blur(14px);
 border-radius:18px;
 padding:14px;
 margin-bottom:12px;
}
input,button{
 width:100%;
 padding:12px;
 border:none;
 border-radius:14px;
 font-size:15px;
}
input{background:#000;color:#fff;margin-bottom:8px;}
button{background:var(--accent);color:#000;font-weight:600;cursor:pointer;}
button:active{transform:scale(.98);}
.small{font-size:12px;opacity:.7;text-align:center;}
#iosBanner{display:none;background:#000;border:1px solid #333;padding:10px;border-radius:14px;font-size:13px;text-align:center;margin-bottom:10px;}
#installSuccess{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.9);color:#00ffd5;font-size:22px;z-index:9999;animation:pop .6s ease;}
@keyframes pop{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
#network{text-align:center;font-size:12px;margin-bottom:8px;opacity:.8;}
canvas{width:100%!important;height:150px!important;margin-top:10px;}
</style>
</head>
<body>
<div class="app">

<!-- iOS helper -->
<div id="iosBanner">
ğŸ“² Install this app<br>Tap <b>Share</b> â†’ <b>Add to Home Screen</b>
</div>

<div class="header">
 <h1>Climix</h1>
 <button class="toggle" id="amoled">ğŸ–¤</button>
</div>

<div id="network">ğŸ“¶ Checking networkâ€¦</div>

<div class="card">
 <input id="city" placeholder="Enter city">
 <button onclick="search()">Search</button>
 <button onclick="useGPS()">ğŸ“ Use My Location</button>
</div>

<div class="card">
 <b>Status</b>
 <div id="status" class="small">Waiting for network & locationâ€¦</div>
</div>

<div class="card">
 <b>Sun / Moon</b>
 <div class="small">
 ğŸŒ… Sunrise: <span id="sunrise">â€”</span><br>
 ğŸŒ‡ Sunset: <span id="sunset">â€”</span><br>
 ğŸŒ™ Moon: <span id="moon">â€”</span>
 </div>
</div>

<div class="card">
 <b>Current Weather</b>
 <div class="small">
 Temp: <span id="temp">â€”</span>Â°C<br>
 Wind: <span id="wind">â€”</span> km/h<br>
 Precip: <span id="precip">â€”</span>%
 </div>
</div>

<div class="card">
 <b>AQI</b>
 <div class="small">
 AQI: <span id="aqi">â€”</span><br>
 Health Score: <span id="aqiScore">â€”</span><br>
 Trend: <span id="aqiTrend">â€”</span><br>
 Safe Outdoor In: <span id="safeTime">â€”</span>
 </div>
</div>

<div class="card">
 <canvas id="aqiChart"></canvas>
</div>

<div class="card">
 <canvas id="tempChart"></canvas>
</div>

<button id="installBtn" style="display:none">â¬‡ï¸ Install App</button>

<div class="small" style="text-align:center;margin-top:10px">
Installs: <span id="installCount">0</span><br>
Â© Manik Roy 2025. All Rights Reserved.
</div>

</div>
<div id="installSuccess">ğŸ‰ App Installed!</div>

<script>
// ----------------- MOBILE SAFE -----------------
let deferredPrompt;
window.addEventListener("beforeinstallprompt", e=>{
 e.preventDefault(); deferredPrompt=e;
 if(!localStorage.getItem("installed")) installBtn.style.display="block";
});

// ----------------- AMOLED -----------------
amoled.onclick=()=>{document.body.classList.toggle("amoled");localStorage.setItem("amoled",document.body.classList.contains("amoled"));}
if(localStorage.getItem("amoled")==="true") document.body.classList.add("amoled");

// ----------------- NETWORK -----------------
function net(){
 network.textContent = navigator.onLine?"ğŸ“¶ Online":"âŒ Offline (cached UI)";
}
window.addEventListener("online",net);
window.addEventListener("offline",net);
net();

// ----------------- IOS BANNER -----------------
const isIOS=/iphone|ipad|ipod/i.test(navigator.userAgent);
const isStandalone=window.matchMedia('(display-mode: standalone)').matches;
if(isIOS&&!isStandalone) iosBanner.style.display="block";

// ----------------- INSTALL BUTTON -----------------
installBtn.onclick=async()=>{
 if(!deferredPrompt) return;
 deferredPrompt.prompt();
 const c=await deferredPrompt.userChoice;
 if(c.outcome==="accepted"){
  installBtn.style.display="none";
  localStorage.setItem("installed","1");
  installSuccess.style.display="flex";
  setTimeout(()=>installSuccess.style.display="none",1800);
 }
 deferredPrompt=null;
};

// ----------------- INSTALL ANALYTICS -----------------
let installs=Number(localStorage.getItem("installCount")||0);
window.addEventListener("appinstalled",()=>{installs++;localStorage.setItem("installCount",installs);installCount.textContent=installs;});
installCount.textContent=installs;
if(localStorage.getItem("installed")) installBtn.style.display="none";

// ----------------- GEO -----------------
function useGPS(){
 navigator.geolocation.getCurrentPosition(p=>{
  loadWeather(p.coords.latitude,p.coords.longitude,"Your Location");
 });
}

// ----------------- SEARCH -----------------
async function search(){
 const q=city.value.trim();
 if(!q) return;
 const geo=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1`).then(r=>r.json()).catch(()=>null);
 if(!geo?.results) return status.textContent="âŒ Location not found";
 const loc=geo.results[0];
 loadWeather(loc.latitude,loc.longitude,loc.name);
}

// ----------------- WEATHER + AQI -----------------
async function loadWeather(lat,lon,name){
 status.textContent="Loading weather...";
 placeName=name;
 try{
  const w=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,precipitation_probability&daily=sunrise,sunset&timezone=auto`).then(r=>r.json());
  const a=await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=us_aqi`).then(r=>r.json());

  // Weather
  temp.textContent=w.current_weather.temperature;
  wind.textContent=w.current_weather.windspeed;
  precip.textContent=w.hourly.precipitation_probability[0];

  sunrise.textContent=w.daily.sunrise[0];
  sunset.textContent=w.daily.sunset[0];
  moon.textContent="Waxing Crescent"; // simplified

  // AQI
  const aqiNow=a.hourly.us_aqi[0];
  aqi.textContent=aqiNow;
  aqiScore.textContent=Math.max(0,100-aqiNow);
  aqiTrend.textContent="Stable"; // basic trend
  safeTime.textContent="1h";

  // Cache
  localStorage.setItem("lastWeather",JSON.stringify({w,a}));

  // Charts
  const hours=Array.from({length:24},(_,i)=>i+"h");
  const aqiData=a.hourly.us_aqi.slice(0,24);
  new Chart(aqiChart,{type:'line',data:{labels:hours,datasets:[{label:'AQI',data:aqiData,borderColor:'red',fill:false,tension:0.2}]}});
  const tempData=w.hourly.temperature_2m.slice(0,24);
  new Chart(tempChart,{type:'line',data:{labels:hours,datasets:[{label:'Temp Â°C',data:tempData,borderColor:'orange',fill:false,tension:0.2}]}});

  status.textContent="Weather loaded successfully";
 }catch(e){
  status.textContent="âš ï¸ Failed to load, using cached data";
  const cached=JSON.parse(localStorage.getItem("lastWeather")||"{}");
  if(cached.w){temp.textContent=cached.w.current_weather.temperature;wind.textContent=cached.w.current_weather.windspeed;precip.textContent=cached.w.hourly.precipitation_probability[0];}
 }
}

// ----------------- BACKGROUND REFRESH -----------------
setInterval(()=>{
 if(document.visibilityState==="visible" && navigator.onLine && placeName){
  search();
 }
},15*60*1000);
</script>
</body>
</html>
