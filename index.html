<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Climix</title>

<style>
body{background:#000;color:#fff;font-family:system-ui;margin:0}
.app{max-width:420px;margin:auto;padding:15px}
.card{background:#111;padding:16px;border-radius:16px;margin-bottom:12px}
input,button{height:42px;border:none;border-radius:12px}
input{width:55%;padding:0 10px}
button{background:#222;color:#fff}
.temp{font-size:3.5rem;text-align:center}
.status{text-align:center;opacity:.7;margin-top:5px}
.row{display:flex;justify-content:space-between;padding:6px 0}
.aqi{text-align:center;font-size:1.5rem}
canvas{width:100%}
</style>
</head>

<body>
<div class="app">

<h2>Climix</h2>

<div class="card">
<input id="city" placeholder="Enter city">
<button onclick="searchCity()">Search</button>
<button onclick="detect()">üìç</button>
</div>

<div class="card">
<div id="temp" class="temp">--¬∞C</div>
<div id="status" class="status">Ready</div>
</div>

<div class="card">
<div class="row">Humidity <span id="hum">--</span></div>
<div class="row">Wind <span id="wind">--</span></div>
<div class="row">Pressure <span id="press">--</span></div>
</div>

<div class="card">
<h3>Air Quality</h3>
<div id="aqi" class="aqi">--</div>
<div id="aqiText" class="status"></div>
</div>

<div class="card">
<h3>Next 24 Hours</h3>
<canvas id="chart" width="350" height="120"></canvas>
</div>

<div class="card" style="text-align:center;font-size:.8rem">
¬© Manik Roy 2025
</div>

</div>

<script>
let busy=false
const $=id=>document.getElementById(id)

/* STATUS */
function setStatus(t){
  $("status").textContent=t
}

/* AUTO LOAD */
window.onload=()=>{
  const lat=localStorage.getItem("lat")
  const lon=localStorage.getItem("lon")
  if(lat && lon) loadWeather(lat,lon)
}

/* LOCATION */
function detect(){
  if(busy) return
  busy=true
  setStatus("Requesting location...")

  navigator.geolocation.getCurrentPosition(
    p=>{
      busy=false
      save(p.coords.latitude,p.coords.longitude)
      loadWeather(p.coords.latitude,p.coords.longitude)
    },
    ()=>{
      busy=false
      setStatus("Location denied")
    },
    {timeout:10000}
  )
}

/* SEARCH */
async function searchCity(){
  if(!$("city").value || busy) return
  busy=true
  setStatus("Searching city...")

  try{
    const url=`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent($("city").value)}&count=1`
    const r=await fetch(url)
    const j=await r.json()

    if(!j.results){
      busy=false
      return setStatus("City not found")
    }

    save(j.results[0].latitude,j.results[0].longitude)
    loadWeather(j.results[0].latitude,j.results[0].longitude)

  }catch{
    busy=false
    setStatus("Search failed")
  }
}

/* WEATHER */
async function loadWeather(lat,lon){
  setStatus("Loading weather...")

  try{
    const url=
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
      `&current=temperature_2m,relative_humidity_2m,wind_speed_10m,pressure_msl`+
      `&hourly=temperature_2m,time`+
      `&timezone=auto`

    const r=await fetch(url)
    const w=await r.json()

    // Use current if exists, else fallback to first hourly
    const tempVal = w.current?.temperature_2m ?? w.hourly?.temperature_2m?.[0]
    const humVal  = w.current?.relative_humidity_2m ?? "-"
    const windVal = w.current?.wind_speed_10m ?? "-"
    const pressVal= w.current?.pressure_msl ?? "-"

    if(tempVal===undefined){
      busy=false
      return setStatus("Weather data unavailable")
    }

    $("temp").textContent=Math.round(tempVal)+"¬∞C"
    $("hum").textContent=humVal+"%"
    $("wind").textContent=windVal+" km/h"
    $("press").textContent=pressVal+" hPa"

    if(w.hourly && w.hourly.temperature_2m){
      drawChart(w.hourly.temperature_2m.slice(0,24))
    }

    loadAQI(lat,lon)
    setStatus("Updated")
    busy=false

  }catch(e){
    console.log("Weather load error:", e)
    busy=false
    setStatus("Weather service busy")
  }
}

/* GRAPH */
function drawChart(data){
  const canvas=$("chart")
  const c=canvas.getContext("2d")

  c.clearRect(0,0,canvas.width,canvas.height)

  const max=Math.max(...data)
  const min=Math.min(...data)
  const step=canvas.width/(data.length-1)

  c.beginPath()
  data.forEach((v,i)=>{
    const x=i*step
    const y=canvas.height-
      ((v-min)/(max-min))*canvas.height
    i?c.lineTo(x,y):c.moveTo(x,y)
  })

  c.strokeStyle="#4af"
  c.lineWidth=2
  c.stroke()
}

/* AQI */
async function loadAQI(lat,lon){
  try{
    const url=
      `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}`+
      `&hourly=pm2_5`

    const r=await fetch(url)
    const a=await r.json()

    if(!a.hourly) return

    const v=a.hourly.pm2_5[0]
    $("aqi").textContent="PM2.5 : "+v
    $("aqiText").textContent=aqiLabel(v)

  }catch{
    $("aqi").textContent="AQI unavailable"
  }
}

/* AQI LABEL */
function aqiLabel(v){
  if(v<=12) return "Good üü¢"
  if(v<=35) return "Moderate üü°"
  if(v<=55) return "Unhealthy (Sensitive) üü†"
  if(v<=150) return "Unhealthy üî¥"
  return "Hazardous ‚ö´"
}

/* SAVE */
function save(lat,lon){
  localStorage.setItem("lat",lat)
  localStorage.setItem("lon",lon)
}
</script>

</body>
</html>
